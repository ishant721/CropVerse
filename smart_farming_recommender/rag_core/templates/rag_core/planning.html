{% block ai_content %}
<div class="text-center my-4">
    <h1 class="display-5 text-success">Detailed Report Generation</h1>
    <p class="lead">Select a past report from the history or generate a new one.</p>
</div>

<div class="row">
    <!-- Sidebar for Report History -->
    <div class="col-md-3">
        <div class="card shadow-sm report-history-sidebar p-2">
            <h5 class="text-center text-success mb-3">Report History</h5>
            <div id="report-history-list">
                {% for report in reports %}
                <div class="report-history-item" data-title="{{ report.title }}" data-content="{{ report.content|escapejs }}" onclick="showReport(this)">
                    <h6>{{ report.title|truncatewords:3 }}</h6>
                    <p>{{ report.created_at|date:"M d, Y, P" }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="col-md-9">
        <div class="main-content p-2">
            <div id="report-display" class="card shadow-sm" style="display: none;">
                <div class="report-display-header">
                    <h4 id="report-display-title" class="text-primary-green mb-0"></h4>
                </div>
                <div id="report-display-content" class="p-4"></div>
            </div>

            <div id="form-container" class="fade-in">
                <div class="card shadow-sm p-4">
                    <form id="report-form" onsubmit="return false;">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="user_report_query" class="form-label">Your Report Query</label>
                            <textarea class="form-control" id="user_report_query" name="user_report_query" rows="4" placeholder="e.g., 'Detailed crop plan for wheat in Gwalior...'"></textarea>
                            <div class="form-text">Describe the kind of report you need. The more detail, the better the result.</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="soil_type" class="form-label">Soil Type</label>
                                <select class="form-select" id="soil_type" name="soil_type">
                                    <option value="">Select Soil Type</option>
                                    <option value="loamy">Loamy</option>
                                    <option value="sandy">Sandy</option>
                                    <option value="clay">Clay</option>
                                    <option value="silt">Silt</option>
                                    <option value="chalky">Chalky</option>
                                    <option value="peaty">Peaty</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="budget" class="form-label">Budget (in USD)</label>
                                <input type="number" class="form-control" id="budget" name="budget" min="0" placeholder="e.g., 5000">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="crop_preference" class="form-label">Crop Preference</label>
                                <input type="text" class="form-control" id="crop_preference" name="crop_preference" placeholder="e.g., Wheat, Rice, Corn">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="land_area" class="form-label">Land Area (in acres)</label>
                                <input type="number" class="form-control" id="land_area" name="land_area" min="0" step="0.1" placeholder="e.g., 5.5">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="climate_zone" class="form-label">Climate Zone</label>
                            <input type="text" class="form-control" id="climate_zone" name="climate_zone" placeholder="e.g., Tropical, Temperate, Arid">
                        </div>
                        <div class="mb-3">
                            <label for="additional_notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="additional_notes" name="additional_notes" rows="3" placeholder="Any other specific requirements or concerns"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="report_image" class="form-label">Upload Image (optional)</label>
                            <input type="file" class="form-control" id="report_image" name="image" accept="image/*">
                        </div>
                        <button type="submit" id="generate-report-btn" class="btn btn-success w-100 py-2">Generate New Report</button>
                    </form>
                    <div id="loading-spinner" class="text-center mt-4" style="display: none;">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Generating your detailed report...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set the marked options
        marked.setOptions({
            gfm: true,
            breaks: true,
            sanitize: true // IMPORTANT: Sanitize user-generated content to prevent XSS
        });

        // Helper function to truncate text by words
        function truncateWords(text, numWords) {
            if (!text) return '';
            const words = text.split(' ');
            if (words.length > numWords) {
                return words.slice(0, numWords).join(' ') + '...';
            }
            return text;
        }

        window.showReport = function(element) {
            // Remove active class from all items
            document.querySelectorAll('.report-history-item').forEach(item => item.classList.remove('active'));
            // Add active class to the clicked item
            element.classList.add('active');

            const title = element.getAttribute('data-title');
            const content = element.getAttribute('data-content');
            const reportDisplay = document.getElementById('report-display');

            document.getElementById('report-display-title').innerText = title;
            document.getElementById('report-display-content').innerHTML = marked.parse(content);
            
            reportDisplay.classList.remove('fade-in');
            void reportDisplay.offsetWidth; // Trigger reflow
            reportDisplay.classList.add('fade-in');
            reportDisplay.style.display = 'block';
            document.getElementById('form-container').style.display = 'none';
        }

        function addReportToHistory(report) {
            const historyList = document.getElementById('report-history-list');
            const newReportItem = document.createElement('div');
            newReportItem.className = 'report-history-item';
            newReportItem.setAttribute('data-title', report.title);
            newReportItem.setAttribute('data-content', report.content);
            newReportItem.setAttribute('onclick', 'showReport(this)');

            const reportTitle = document.createElement('h6');
            reportTitle.innerText = truncateWords(report.title, 3); // Truncate here

            const reportDate = document.createElement('p');
            reportDate.innerText = report.created_at;

            newReportItem.appendChild(reportTitle);
            newReportItem.appendChild(reportDate);

            historyList.prepend(newReportItem); // Add new report to the top
        }

        document.getElementById('generate-report-btn').addEventListener('click', async function(event) {
            event.preventDefault();

            const form = document.getElementById('report-form');
            const formData = new FormData(form);

            const loadingSpinner = document.getElementById('loading-spinner');
            const formContainer = document.getElementById('form-container');
            const reportDisplay = document.getElementById('report-display');

            formContainer.style.display = 'none';
            reportDisplay.style.display = 'none';
            loadingSpinner.style.display = 'block';

            try {
                const response = await fetch('/rag/api/generate-report/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    const newReport = result.new_report;
                    
                    addReportToHistory(newReport);

                    document.getElementById('report-display-title').innerText = newReport.title;
                    document.getElementById('report-display-content').innerHTML = marked.parse(newReport.content);
                    
                    reportDisplay.classList.remove('fade-in');
                    void reportDisplay.offsetWidth; // Trigger reflow
                    reportDisplay.classList.add('fade-in');
                    reportDisplay.style.display = 'block';

                } else {
                    const title = "Error";
                    const content = `Error: ${result.error || 'Something went wrong.'}`;
                    
                    document.getElementById('report-display-title').innerText = title;
                    document.getElementById('report-display-content').innerHTML = `<p class="text-danger">${content}</p>`;
                    reportDisplay.style.display = 'block';
                }
            } catch (error) {
                console.error('Error generating report:', error);
                document.getElementById('report-display-title').innerText = "Error";
                document.getElementById('report-display-content').innerHTML = '<p class="text-danger">An unexpected error occurred. Please try again.</p>';
                reportDisplay.style.display = 'block';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
